<!DOCTYPE HTML>
<html>
    <head>
        <link rel="stylesheet" href="css/main.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    </head>
    <body>
      <div class="container">
        <div class="form_wrapper">
          <ul id="tab-nav">
            <li><a href="#tts_form"><span>Text to Speech</span></a></li>
            <li><a href="#file_form"><span>Upload File</span></a></li>
          </ul>
          <div id="form-div">
          <form id="file_form" class="form">
            <input id="local_file" name="local_file" type="file">
            <div><input class="button" type="submit" value="Play" style="float: right;"></div>
          </form>
          <form id="tts_form" class="form">
              <label for="lyrics">Lyrics</label>
              <div><input id="lyrics"  name="lyrics" type="text" value="Hello world!" maxlength="100"/></div>
              <div>
              <select id="language" name="language">
                <option value="en">English</option>
                <option value="fr">French</option>
                <option value="da">Danish</option>
                <option value="fi">Finnish</option>
                <option value="ru">Russian</option>
                <option value="es">Spanish</option>
                <option value="it">Italian</option>
                <option value="zh">Chinese</option>
                <option value="ja">Japanese</option>
                <option value="ko">Korean</option>
                <option value="hi">Hindi</option>
                <option value="hu">Hungarian</option>
                <option value="no">Norwegian</option>
                <option value="sv">Swedish</option>
                <option value="de">German</option>
              </select>
              <input class="button" type="submit" value="Play" style="float: right;">
              </div>
          </form>
          <div>
            <label for="loop">Loop?</label>
          <input id="loop" name="loop" type="checkbox" onclick='loopClick(this);'/> 
          </div>
          <div>
            <label for="fft_size">FFT Size</label>
            <select id="fft_size" name="fft_size" onchange="fftSizeChange(this);">
              <option value="32">32</option>
              <option value="64">64</option>
              <option value="128">128</option>
              <option value="256">256</option>
              <option value="512">512</option>
              <option value="1024" selected="selected">1024</option>
              <option value="2048">2048</option>
            </select>
          </div>
          </div>
          <audio id="player" preload="auto" controls>Your browser does not support the audio element.</audio>
        </div>
        <div id="canvas_wrapper">
          <canvas id="oscilloscope" width="10000" height="150"></canvas>
          <canvas id="waveform" width="10000" height="150"></canvas>
          <canvas id="spectrum" width="10000" height="150"></canvas>
          <canvas id="spectrogram" width="10000" height="150"></canvas>
        </div>
      </div>
    </body>
    
<script type="text/javascript">
var context;
var source;
var audio_buffer;
var analyser;
var is_playing = false;
window.start_time = 0;
window.pause_time = 0;

var analyser2;
var scriptProcessor2;

var ctx_spectrum;
var gradient;

var ctx_spectrogram;
var tempCtx;

var ctx_oscilloscope;

var ctx_waveform;
var scriptProcesser4;
var waveform_x = 0;
var waveform_y = 150;

window.addEventListener('load', init, false);
function init() {
  try {
    window.AudioContext = window.AudioContext||window.webkitAudioContext;
    context = new AudioContext();
  }
  catch(e) {
    alert('Web Audio API is not supported in this browser');
  }
  finally{
    var audio = document.getElementById('player');
    //source = context.createBufferSource();
    //source.connect(context.destination);

    analyser = context.createAnalyser();
    analyser.smoothingTimeConstant = 0.3;
    analyser.fftSize = 1024;
    analyser.connect(context.destination);

    analyser2 = context.createAnalyser();
    analyser2.smoothingTimeConstant = 0;
    analyser2.fftSize = 1024;

    initCanvas();
  }
}

function initCanvas() {
  var canvas = document.getElementById('spectrum');
  ctx_spectrum = canvas.getContext('2d');
  canvas.width  = canvas.offsetWidth;
  //canvas.width = window.innerWidth;
  gradient = ctx_spectrum.createLinearGradient(0,0,0,canvas.height);
  gradient.addColorStop(1,'#000000');
  gradient.addColorStop(0.85,'#ff0000');
  gradient.addColorStop(0.35,'#ffff00');
  gradient.addColorStop(0,'#ffffff');

  scriptProcessor = context.createScriptProcessor();
  scriptProcessor.connect(context.destination);
  analyser.connect(scriptProcessor);
  scriptProcessor.onaudioprocess = drawSpectrum;

  var canvas2 = document.getElementById('spectrogram');
  ctx_spectrogram = canvas2.getContext('2d');
  canvas2.width  = canvas2.offsetWidth;

  var tempCanvas = document.createElement("canvas");
  tempCtx = tempCanvas.getContext("2d");
  tempCanvas.width=canvas2.width;
  tempCanvas.height=canvas2.height;

  scriptProcessor2 = context.createScriptProcessor();
  scriptProcessor2.connect(context.destination);
  analyser2.connect(scriptProcessor2);
  scriptProcessor2.onaudioprocess = drawSpectrogram;

  var canvas3 = document.getElementById('oscilloscope');
  ctx_oscilloscope = canvas3.getContext('2d');
  canvas3.width  = canvas3.offsetWidth;
  scriptProcessor3 = context.createScriptProcessor();
  scriptProcessor3.connect(context.destination);
  analyser.connect(scriptProcessor3);
  scriptProcessor3.onaudioprocess = drawOscilloscope;

  var canvas4 = document.getElementById('waveform');
  ctx_waveform = canvas4.getContext('2d');
  canvas4.width  = canvas4.offsetWidth;
  scriptProcessor4 = context.createScriptProcessor();
  scriptProcessor4.connect(context.destination);
  analyser.connect(scriptProcessor4);
  scriptProcessor4.onaudioprocess = drawWaveform;
}

function drawOscilloscope() {
  var array = new Uint8Array(analyser.frequencyBinCount);
  analyser.getByteTimeDomainData(array);
  var canvas = ctx_oscilloscope.canvas;
  ctx_oscilloscope.clearRect(0,0,canvas.width,canvas.height);

  ctx_oscilloscope.lineWidth = 3;
  ctx_oscilloscope.strokeStyle = 'rgb(255, 255, 255)';
  ctx_oscilloscope.beginPath();
  for (var i = 0; i < array.length; i++) {
      var value = array[i] / 256;
      x = i*canvas.width/analyser.frequencyBinCount;
      y = value * canvas.height;
      if(i === 0) {
        ctx_oscilloscope.moveTo(x, y);
      } else {
        ctx_oscilloscope.lineTo(x, y);
      }
  }
  ctx_oscilloscope.lineTo(canvas.width, canvas.height/2);
  ctx_oscilloscope.stroke();
};

function drawWaveform() {
  if(!is_playing){
  //if (document.getElementById('player').paused){
    return;
  }
  var array = new Uint8Array(analyser.frequencyBinCount);
  analyser.getByteTimeDomainData(array);
  var canvas = ctx_waveform.canvas;

  //audioDuration = document.getElementById('player').duration;
  audioDuration = audio_buffer.duration;
  //totalSamples = audioDuration * context.sampleRate;
  totalSamples = audio_buffer.length;
  timeBinWidth = (canvas.width)/(totalSamples/scriptProcessor4.bufferSize);
  if(isNaN(timeBinWidth)){
    return;
  }

  ctx_waveform.lineWidth = 1;
  ctx_waveform.strokeStyle = 'rgb(255, 255, 255)';
  ctx_waveform.beginPath();
  ctx_waveform.moveTo(waveform_x, waveform_y);
  for (var i = 0; i < array.length; i++) {
    var value = array[Math.floor(i)] / 256;
    waveform_x += timeBinWidth/array.length;
    if (waveform_x > canvas.width){
      waveform_x = 0;
      ctx_waveform.clearRect(0,0,canvas.width,canvas.height);
      ctx_waveform.moveTo(waveform_x, waveform_y);
    }
    waveform_y = value * canvas.height;
    ctx_waveform.lineTo(waveform_x, waveform_y);
  }
  ctx_waveform.stroke();
};

function drawSpectrum() {
  var array =  new Uint8Array(analyser.frequencyBinCount);
  analyser.getByteFrequencyData(array);
  ctx_spectrum.clearRect(0, 0, ctx_spectrum.canvas.width, ctx_spectrum.canvas.height);
  ctx_spectrum.fillStyle=gradient;
  for ( var i = 0; i < (array.length); i++ ){
    var value = ctx_spectrum.canvas.height*array[i]/256;
    var binWidth = ctx_spectrum.canvas.width/analyser.frequencyBinCount;
    ctx_spectrum.fillRect(i*binWidth,ctx_spectrum.canvas.height,binWidth*3/4,-value);
  }
};

function drawSpectrogram() {
  if (!is_playing) {
  //if (document.getElementById('player').paused){
      return;
  }
  //Copy current canvas to temp canvas
  canvas = ctx_spectrogram.canvas;
  tempCtx.drawImage(canvas, 0, 0, canvas.width, canvas.height);

  var array = new Uint8Array(analyser2.frequencyBinCount);
  analyser2.getByteFrequencyData(array);

  //audioDuration = document.getElementById('player').duration;
  audioDuration = audio_buffer.duration;
  //totalSamples = audioDuration * context.sampleRate;
  totalSamples = audio_buffer.length;
  timeBinWidth = canvas.width/(totalSamples/scriptProcessor2.bufferSize);
  timeBinWidth = Math.max(timeBinWidth, 1);
  freqBinWidth = canvas.height/analyser2.frequencyBinCount;

  for (var i = 0; i < array.length; i++) {
      var value = array[i];
      // draw the line at the right side of the canvas
      ctx_spectrogram.fillStyle = "#" + value.toString(16)+value.toString(16)+value.toString(16);
      ctx_spectrogram.fillRect(canvas.width - timeBinWidth, canvas.height - i*freqBinWidth, timeBinWidth, canvas.height/array.length);
  }
  ctx_spectrogram.translate(-timeBinWidth, 0);
  ctx_spectrogram.drawImage(tempCtx.canvas, 0, 0, canvas.width, canvas.height, 0, 0, canvas.width, canvas.height);
  ctx_spectrogram.setTransform(1, 0, 0, 1, 0, 0);
};

$(document).ready(function(){

  $('#file_form').hide();  
  $('#tab-nav li').click(function(e) {
    $('.form').hide();
    $('#tab-nav .current').removeClass("current");
    $(this).addClass('current');
    
    var clicked = $(this).find('a:first').attr('href');
    $(clicked).fadeIn('fast');
    e.preventDefault();
  }).eq(0).addClass('current');


  $('#file_form').submit(function () {
    // var file = $("#local_file").val();
    // var audio_object = window.createObjectURL(file); 
    // var audio = document.createElement('audio');
    // audio.setAttribute('src', file);
    // audio.play();
    var audio = document.getElementById('player');
    audio.currentTime=0;
    audio.play();
    return false;
  });


  $('#tts_form').submit(function () {
    var lang = $.trim($("#language").val());
    var lyrics = $.trim($("#lyrics").val());

    var url = '/tts?' + "&lang=" + encodeURIComponent(lang) + "&q=" + encodeURIComponent(lyrics);
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.responseType = 'arraybuffer';

    xhr.onload = function(e) {
      if (this.status == 200) {
        context.decodeAudioData(xhr.response, start_audio);
      }
    };
    xhr.send();

    // var audio = document.getElementById('player');
    // audio.setAttribute('src', src);
    // audio.play();
    return false;
  });

  $(document).on('keypress', function(e) {
    var tag = e.target.tagName.toLowerCase();
    if ( e.which === 32 && tag != 'input' && tag != 'textarea'){
      if(is_playing){
        source.stop(0);
      }else{
        start_audio(audio_buffer, 0);
      }
      // var audio = document.getElementById('player');
      // if (audio.paused) {
      //     audio.play();
      // } else {
      //     audio.pause();
      // }
    }
  });

});

function handleFileSelect(evt) {
  var files = evt.target.files; // FileList object
  var file = files[0];
  var reader = new FileReader();
  // Closure to capture the file information.
  reader.onload = (function(theFile) {
    return function(e) {
      context.decodeAudioData(e.target.result, start_audio);
      // playSound(e.target.result);
      // var audio = document.getElementById('player');
      // audio.setAttribute('src', e.target.result);
      // audio.play();
    };
  })(file);
  reader.readAsArrayBuffer(file);
}
document.getElementById('local_file').addEventListener('change', handleFileSelect, false);

function loopClick(checkboxElement){
  //var audio = document.getElementById('player');
  //audio.loop = checkboxElement.checked;
  source.loop = checkboxElement.checked;
}

function fftSizeChange(selectElement){
  var newValue = selectElement.value;
  analyser.fftSize = newValue;
  analyser2.fftSize = newValue;
}

function start_audio(audioBuffer, start_time){
  if (typeof audioBuffer !== 'undefined') {
    audio_buffer = audioBuffer;
  }
  if (typeof start_time == 'undefined') {
    start_time = 0;
  }
  source = context.createBufferSource();
  source.connect(analyser);
  source.connect(analyser2);
  source.buffer = audio_buffer;
  source.start(0,start_time);
  is_playing = true;
  source.onended = function() {
    is_playing = false;
  }
}
</script>
</html>


