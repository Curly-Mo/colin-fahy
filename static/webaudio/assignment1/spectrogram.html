<!DOCTYPE HTML>
<html>
    <head>
        <link rel="stylesheet" href="css/main.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    </head>
    <body>
      <div class="container">
        <div class="form_wrapper">
          <ul id="tab-nav">
            <li><a href="#tts_form"><span>Text to Speech</span></a></li>
            <li><a href="#file_form"><span>Upload File</span></a></li>
          </ul>
          <div id="form-div">
          <form id="file_form" class="form">
            <input id="local_file" name="local_file" type="file">
            <div><input class="button" type="submit" value="Play" style="float: right;"></div>
          </form>
          <form id="tts_form" class="form">
              <label for="lyrics">Lyrics</label>
              <div><input id="lyrics"  name="lyrics" type="text" value="Hello world!" maxlength="100"/></div>
              <div>
              <select id="language" name="language">
                <option value="en">English</option>
                <option value="fr">French</option>
                <option value="da">Danish</option>
                <option value="fi">Finnish</option>
                <option value="ru">Russian</option>
                <option value="es">Spanish</option>
                <option value="it">Italian</option>
                <option value="zh">Chinese</option>
                <option value="ja">Japanese</option>
                <option value="ko">Korean</option>
                <option value="hi">Hindi</option>
                <option value="hu">Hungarian</option>
                <option value="no">Norwegian</option>
                <option value="sv">Swedish</option>
                <option value="de">German</option>
              </select>
              <input class="button" type="submit" value="Play" style="float: right;">
              </div>
          </form>
          <div>
            <label for="loop">Loop?</label>
          <input id="loop" name="loop" type="checkbox" onclick='loopClick(this);'/> 
          </div>
          <div>
            <label for="fft_size">FFT Size</label>
            <select id="fft_size" name="fft_size" onchange="fftSizeChange(this);">
              <option value="32">32</option>
              <option value="64">64</option>
              <option value="128">128</option>
              <option value="256">256</option>
              <option value="512">512</option>
              <option value="1024">1024</option>
              <option value="2048" selected="selected">2048</option>
            </select>
          </div>
          </div>
          <audio id="player" preload="auto" controls>Your browser does not support the audio element.</audio>
        </div>
        <div id="canvas_wrapper">
          <canvas id="spectrum" width="10000" height="300"></canvas>
          <canvas id="spectrogram" width="10000" height="300"></canvas>
        </div>
      </div>
    </body>
    
<script type="text/javascript">
var context;
var source;
var analyser;
var scriptProcessor;

var analyser;
var scriptProcessor2;

var canvasCtx;
var gradient;


var canvasCtx2;
var tempCtx;

window.addEventListener('load', init, false);
function init() {
  try {
    window.AudioContext = window.AudioContext||window.webkitAudioContext;
    context = new AudioContext();
  }
  catch(e) {
    alert('Web Audio API is not supported in this browser');
  }
  finally{
    var audio = document.getElementById('player');
    source = context.createMediaElementSource(audio);
    source.connect(context.destination);

    analyser = context.createAnalyser();
    analyser.smoothingTimeConstant = 0.3;
    analyser.fftSize = 2048;
    source.connect(analyser);

    analyser2 = context.createAnalyser();
    analyser2.smoothingTimeConstant = 0;
    analyser2.fftSize = 2048;
    source.connect(analyser2);

    initCanvas();
  }
}

function initCanvas() {
  var canvas = document.getElementById('spectrum');
  canvasCtx = canvas.getContext('2d');
  canvas.width  = canvas.offsetWidth;
  //canvas.width = window.innerWidth;
  gradient = canvasCtx.createLinearGradient(0,0,0,300);
  gradient.addColorStop(1,'#000000');
  gradient.addColorStop(0.85,'#ff0000');
  gradient.addColorStop(0.35,'#ffff00');
  gradient.addColorStop(0,'#ffffff');

  scriptProcessor = context.createScriptProcessor();
  scriptProcessor.connect(context.destination);
  analyser.connect(scriptProcessor);
  scriptProcessor.onaudioprocess = drawSpectrum;

  var canvas2 = document.getElementById('spectrogram');
  canvasCtx2 = canvas2.getContext('2d');
  canvas2.width  = canvas2.offsetWidth;

  var tempCanvas = document.createElement("canvas");
  tempCtx = tempCanvas.getContext("2d");
  tempCanvas.width=canvas2.width;
  tempCanvas.height=canvas2.height;

  scriptProcessor2 = context.createScriptProcessor();
  scriptProcessor2.connect(context.destination);
  analyser2.connect(scriptProcessor2);
  scriptProcessor2.onaudioprocess = drawSpectrogram;
}

function drawSpectrum() {
  var array =  new Uint8Array(analyser.frequencyBinCount);
  analyser.getByteFrequencyData(array);
  canvasCtx.clearRect(0, 0, canvasCtx.canvas.width, canvasCtx.canvas.height);
  canvasCtx.fillStyle=gradient;
  for ( var i = 0; i < (array.length); i++ ){
    var value = array[i];
    var binWidth = canvasCtx.canvas.width/analyser.frequencyBinCount;
    canvasCtx.fillRect(i*binWidth,canvasCtx.canvas.height,binWidth*3/4,-value);
  }
};

function drawSpectrogram() {
  //if (source.playbackState != source.PLAYING_STATE) {
  if (document.getElementById('player').paused){
      return;
  }
  //Copy current canvas to temp canvas
  canvas = canvasCtx2.canvas;
  tempCtx.drawImage(canvas, 0, 0, canvas.width, canvas.height);

  var array = new Uint8Array(analyser2.frequencyBinCount);
  analyser2.getByteFrequencyData(array);

  audioDuration = document.getElementById('player').duration;
  totalSamples = audioDuration * context.sampleRate;
  timeBinWidth = canvas.width/(totalSamples/scriptProcessor2.bufferSize);
  timeBinWidth = Math.max(timeBinWidth, 1);
  freqBinWidth = canvas.height/analyser2.frequencyBinCount;

  for (var i = 0; i < array.length; i++) {
      var value = array[i];
      // draw the line at the right side of the canvas
      canvasCtx2.fillStyle = "#" + value.toString(16)+value.toString(16)+value.toString(16);
      canvasCtx2.fillRect(canvas.width - timeBinWidth, canvas.height - i*freqBinWidth, timeBinWidth, canvas.height/array.length);
  }
  canvasCtx2.translate(-timeBinWidth, 0);
  canvasCtx2.drawImage(tempCtx.canvas, 0, 0, canvas.width, canvas.height, 0, 0, canvas.width, canvas.height);
  canvasCtx2.setTransform(1, 0, 0, 1, 0, 0);
};

$(document).ready(function(){

  $('#file_form').hide();  
  $('#tab-nav li').click(function(e) {
    $('.form').hide();
    $('#tab-nav .current').removeClass("current");
    $(this).addClass('current');
    
    var clicked = $(this).find('a:first').attr('href');
    $(clicked).fadeIn('fast');
    e.preventDefault();
  }).eq(0).addClass('current');


  $('#file_form').submit(function () {
    // var file = $("#local_file").val();
    // var audio_object = window.createObjectURL(file); 
    // var audio = document.createElement('audio');
    // audio.setAttribute('src', file);
    // audio.play();
    var audio = document.getElementById('player');
    audio.currentTime=0;
    audio.play();
    return false;
  });


  $('#tts_form').submit(function () {
    var tts_url = "http://translate.google.com/translate_tts?";
    var lang = $.trim($("#language").val());
    var lyrics = $.trim($("#lyrics").val());
    var src = tts_url + "tl=" + encodeURIComponent(lang) + "&q=" + encodeURIComponent(lyrics);
    var audio = document.getElementById('player');
    audio.setAttribute('src', src);
    audio.play();
    return false;
  });

});

function handleFileSelect(evt) {
  var files = evt.target.files; // FileList object
  var file = files[0];
  var reader = new FileReader();
  // Closure to capture the file information.
  reader.onload = (function(theFile) {
    return function(e) {
      // playSound(e.target.result);
      var audio = document.getElementById('player');
      audio.setAttribute('src', e.target.result);
      audio.play();
    };
  })(file);
  reader.readAsDataURL(file);
}
document.getElementById('local_file').addEventListener('change', handleFileSelect, false);

function loopClick(checkboxElement){
  var audio = document.getElementById('player');
  audio.loop = checkboxElement.checked;
}

function fftSizeChange(selectElement){
  var newValue = selectElement.value;
  analyser.fftSize = newValue;
  analyser2.fftSize = newValue;
}

</script>
</html>


